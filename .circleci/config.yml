version: 2.1

orbs:
  win: circleci/windows@2.2.0

jobs:
  build:
    executor:
      name: win/default
      shell: powershell.exe
    steps:
      - checkout
      - run:
          name: "Check if license is expired"
          shell: powershell.exe
          command: |
            Import-Module -Name 'C:\Users\circleci\project\VSCELicense.psd1'
            Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process
            $test = Get-VSCELicenseExpirationDate -Version 2019
            $expiryStr = $test.ExpirationDate -replace "`n",", " -replace "`r",", "
            Write-Output 'Expiry Date:', $expiryStr
            if((Get-Date).AddDays(-2) -ge $test.ExpirationDate) {
              Write-Output 'The license is still in date'
              Exit 0
            } else {
              Write-Output 'The license is expiring and needs to be updated'
              Exit 1
            }
